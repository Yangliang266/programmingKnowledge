> 内存页，磁盘块，缓存cacheline都是逻辑概念，即是为了在软件层面达到某种便于管理的目的而设计的

### 磁盘

#### 概念

##### 扇区

> 磁盘的最小存储单位

- 4k对齐

  > 随着时代发展，硬盘容量不断扩展，每个扇区512字节改为每个扇区4096 个字节

##### 磁盘块

> 文件系统读写数据的最小单位；

- 大小

  > 一个磁盘块由连续几个（2^n）扇区组成；

- 为什么存在磁盘块？

  > 我们知道对于HDD来说，其硬件最小的读写单位是扇区（读写粒度 512字节）。而一般HDD的容量大，文件系统若按扇区为读写粒度并不方便(这种表述并不具体)，由于扇区的数量比较小，数目众多在寻址时比较困难，而且由于磁盘IO性能的瓶颈，细粒度的读写既低效，也会损害磁盘的寿命。所以操作系统就将相邻的扇区组合在一起，形成一个块（这个概念在windows中被称为簇），文件系统以块大小为单位对磁盘进行读写。与硬盘打交道，就是以块为最小单位

  > 分离对底层的依赖：操作系统忽略对底层物理存储结构的设计。通过虚拟出来磁盘块的概念，在系统中认为块是最小的单位。

##### 页

> 内存的最小存储单位；

- 大小

  页的大小为磁盘块大小的2^n倍

- 为什么存在页?

  > 操作系统经常与内存和硬盘这两种存储设备进行通信，类似于“块”的概念，都需要一种虚拟的基本单位。所以，与内存操作，是虚拟一个页的概念来作为最小单位
  >
  > 内存相对于磁盘是个高性能存储设备，物理上内存是按字节寻址的。分页这个概念出现在虚拟内存中。虚拟内存的意义是：对于每个进程来说，他们拥有内存（虚拟）空间是大且连续的。而这些大且连续的虚拟内存对应在物理内存上的位置是离散分布的。其中的映射关系被称为页表。但即便这样为什么要分页呢？直接按字节把每个虚拟内存地址和物理内存地址一一对应不行么?我的答案是：这么做理论上不会产生内存碎片，因为粒度足够小，但这需要维护一个巨大的映射关系表。 而且现代处理器都采用多进程共享内存资源，每个进程都需要建立和维护属于自己的页表。这样的页表的存储空间开销会很大。因此操作系统把虚拟内存分为一定大小的页面（一般4096B）。物理内存相应划分为一定大小的页面帧。据此，虚拟地址划分为虚拟页号+页内偏移，物理地址划分为页帧号+页内偏移。这样形成的页表较为精简，方便管理，做虚拟页号与页帧号之间的映射。而页大小也不能过大，这样在实际物理内存上可能会产生小于一个页大小的内存碎片。

#### 磁盘的分层

![在这里插入图片描述](https://yliang.oss-cn-shanghai.aliyuncs.com/img/programming/8a6d523b6cc1627a9b58ca9f94b5c695.png)

![在这里插入图片描述](https://yliang.oss-cn-shanghai.aliyuncs.com/img/programming/4b17c18f44155522dff0d9c864dd2980.png)

##### 物理层面

> 一个磁盘按层次分为磁盘组合->单个磁盘->某一盘面->某一磁道->某一扇区。每个磁盘有多条同心圆似的磁道，磁道被分割成多个部分，每部分弧长加到圆心的半径形成一个扇形，叫扇区。扇区是磁盘中的最小物理存储单位。

##### 逻辑层面

> 磁盘块（虚拟）是操作系统中最小的逻辑存储单位。操作系统与磁盘打交道的最小单位是磁盘块。一个块大小=一个扇区大小*2的n次方





#### 查看

页大小查看： getconf PAGE_SIZE，常见为4K；
磁盘块大小查看：stat /boot/|grep “IO Block”，常见为4K；
扇区大小查看：fdisk -l，常见为512Byte；





##### 为什么缓存要有cacheline？

缓存比内存性能还好，那不更有理由以字节为读写粒度了么？应该这么理解，缓存设置的目的是为了弥补不同速率设备间的性能差异，其原理是利用访存的局部性。而存储一段连续的内存块（这里的内存块也是个逻辑概念，且仅存在于缓存逻辑中，与磁盘块或内存页并不相同）是利用了访存的空间局部性，即当前访问的位置，在未来不远的时间内再次访问其相邻位置的可能较大。这也是为了增加cache命中的手段。