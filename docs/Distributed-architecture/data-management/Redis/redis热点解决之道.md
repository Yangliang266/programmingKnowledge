**热点问题概述**

![1](https://yqfile.alicdn.com/8d10b8663b1156f989bf1f9e4077f4d4cc4159f2.png)

从基于用户消费的数据远远大于生产的数据的角度来讲，我们平常使用的知乎等软件时，大多数人平常仅仅只是浏览，并不会去提问问题、发表的文章，偶尔会发表自己的文章或者看法，这就是一个典型的读多写少的情景，当然此类情景不太容易导致热点的产生。

在日常工作生活中一些突发的的事件，诸如：“双11”期间某些热门商品的降价促销，当这其中的某一件商品被数万次点击、购买时，会形成一个较大的需求量，这种情况下就会产生一个单一的Key，这样就会引起一个热点；同理，当被大量刊发、浏览的热点新闻，热点评论等也会产生热点；另外，在服务端读数据进行访问时，往往会对数据进行分片切分，此类过程中会在某一主机Server上对相应的Key进行访问，当访问超过主机Server极限时，就会导致热点Key问题的产生。

**在了解热点问题产生后，为何要重视热点Key？**

![2](https://yqfile.alicdn.com/2910dcd6836783fb19554b406182a9fd320763af.png)

就像前文讲到的一样，当某一热点的Key在某一主机上超过该主机网卡上线时，由于流量的过度集中，会导致服务器中其它服务无法进行。

![3](https://yqfile.alicdn.com/bc87fc3b484e75aaf977be669aabc53a3b2eb93f.png)

此外，热点Key的缓存过多，超过目前的缓存容量时，就会导致缓存分片服务被打垮现象的产生。当缓存服务崩溃后，此时再有请求产生，会缓存到后台DB上，由于其本身性能较弱，在面临大请求时很容易发生请求穿透现象，会进一步导致“雪崩”现象，严重影响设备的性能。

**常见问题解决方案**

在了解到热点Key产生的原因及引起的问题后，那么究竟该如何解决此类问题？通常来说在上述问题的解决上，目前主要还是集中在客户端和Server端进行相应的改造。

![4](https://yqfile.alicdn.com/65b447c63f2cfe3fc89fa55be7ac07812ff9973e.png)

**1.服务端缓存方案**
首先Client会将请求发送至Server上，而Server又是一个多线程的服务，本地就具有一个小的缓存空间。当Server本身就拥堵时，Server不会将请求进一步发送给DB而是直接返回，只有当Server本身畅通时才会将Client请求发送至DB，并且将该数据重新写入到Cache中。

此时就完成了缓存的访问跟重建，但是该方案也存在问题。
1）缓存失效，多线程构建缓存问题。
2）缓存丢失，缓存构建问题。
3）脏读问题。

**2.使用Memcache、Redis方案**

![5](https://yqfile.alicdn.com/3aa504816371c37230edecd032d10084399886f5.png)

该类方案通过在客户端单独部署缓存的方式来解决热点Key问题。使用过程中Client首先访问服务层，再对同一主机上的缓存层进行访问。该种解决方案具有就近访问、速度快等优点，但是同时也具有：

1）内存资源浪费。
2）脏读问题。

在上述及较为传统的解决方案上在本地缓存上都面临相似的问题，诸如需要获知热点、缓存容量有限、不一致时间增长和热点Key遗漏等。那么究竟该如何进一步的解决上述方案呢？

**阿里云数据库解热点之道**

**1.读写分离方案**

![6](https://yqfile.alicdn.com/2f0aa2e547db0d16364192307ed4b3c3c1839003.png)

架构中个节点的作用：
1）SLB层做负载均衡
2）Proxy层做读写分离自动路由
3）Master负责写
4）ReadOnly节点负责读请求
5）Slave节点和Master节点做高可用

实际过程中Client将请求传到SLB，SLB又将其分发至多个Proxy内，通过Proxy对请求的识别，将其进行分类发送。例如，将同为Write的请求发送到Master模块内，而将Read的请求发送至ReadOnly模块。而模块中的节点具有可以进一步扩充的优点，可以有效解决热点数据多的问题。读写分离同时具有可以灵活扩容读热点能力、可以存储大量热点Key和对客户友好等优点。

**2.热点数据解决方案**

![7](https://yqfile.alicdn.com/f4898a0b1f665a7c36ac38d1b88fac2ce47a061a.png)

与上述方案不同，该方案通过主动发现热点并对其进行存储来解决热点Key的问题。首先Client也会访问SLB，并且通过SLB将各种请求分发至Proxy中，Proxy会按照基于路由的方式将请求转发至后端的Redis中。

在热点key的解决上是采用在服务端增加缓存的方式进行。具体来说就是在Proxy上增加本地缓存，本地缓存采用LRU算法来缓存热点数据，后端db节点增加热点数据计算模块来返回热点数据。

**Proxy架构的主要优点有：**

1）Proxy缓存热点，读能力可水平扩展
2）DB自动计算热点Key
3）对客户端完全透明，不需要做任何兼容

**DB计算热点时，主要运用的方法和优势有：**

1）基于统计阀值的热点统计。
2） 基于统计周期的热点统计。
3） 基于版本号实现的无需重置初值统计方法。
DB计算同时具有对性能影响极其微小、内存占用极其微小等优点。

**3.热点数据的读取**

![8](https://yqfile.alicdn.com/91ec986df50199664b74940f4bf66f075bca2891.png)

在热点Key的处理上主要分为写入跟读取两种形式，在数据写入过程当SLB收到数据K1并将其通过某一个Proxy写入一个Redis，完成数据的写入。假若经过后端热点模块计算发现K1成为热点key后，Proxy会将该热点进行缓存，当下次客户端再进行访问K1时，可以不经Redis，最后由于proxy是可以水平扩充的，因此可以任意增强热点数据的访问能力。

**4.热点数据发现**

![9](https://yqfile.alicdn.com/a2b9d00759432d2620920face4ed697e0793be72.png)

对于db上热点数据的发现，首先会在一个周期内对Key进行请求统计，在达到请求量级后会对热点Key进行热点定位，并将所有的热点Key放入一个小的LRU链表内，在通过Proxy请求进行访问时，若Redis发现待访点是一个热点，就会进入一个反馈阶段，同时对该数据进行标记。

通过上述对比分析可以看出，阿里云在解决热点Key上较传统方法相比都有较大的提高，无论是基于读写分离方案还是热点数据解决方案，在实际处理环境中都可以做灵活的水平能力扩充、都对客户端透明、都有一定的数据不一致性。此外读写分离模式可以存储更大量的热点数据，而基于Proxy的模式有成本上的优势。