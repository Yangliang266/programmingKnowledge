## 网络协议 tcp/ip协议

### 网络模型

#### 1 osi七层网络模型

> 应用层，表示层，会话层，传输层，网络层，数据链路层，物理层

#### 2 tcp/ip四层模型

> 应用层，传输层，网络层，网络接口层

![img](https://yliang.oss-cn-shanghai.aliyuncs.com/img/programming/%E7%BD%91%E7%BB%9C%E5%B1%82.png)



##### 应用层

> 应用层向用户提供服务，通信由逻辑连接提供

- 提供服务

  - 最高层，不向其他协议提供服务，只接受传输层协议提供的服务

  - 应用层模式

    - 传统模式：客户机-服务器模式
    - 新模式：端对端模式

  - 标准化客户机-服务器应用

    - 万维网和超文本传输协议

    - 客户端(浏览器)

    - 服务器

    - 统一资源定位器(URL)

       

      把以下4部分结合进行设计的

      - 协议：为了访问网页需要的第一个标识符是客户机-服务器程序的缩写
      - 主机: 可以是主机ip抑或是服务器的特定名称
      - 端口：为客户机-服务器应用程序定义的16位整数
      - 路径：路径标识该文件在基本的操作系统中的名字和位置
      - protocol://host:port/path

    - 超文本传输协议

      - 用来定义如何编写客户机-服务器程序以便于从网络中检索网页的协议

  - 文件传输协议

    - 用于从一台计算机复制到另一台计算机上去

  - 域名系统DNS

    - 用户将主机名传递给文件传输客户端
    - 文件传输客户端传递给dns客户端
    - dns客户端传递给dns服务器
    - dns服务器解析成数字化的地址即ip地址
    - dns服务器传递给dns客户端
    - dns客户端传递给文件传输服务器
    - 文件传输客户端使用IP地址访问文件传输服务器

#####  传输层

> 从网络层接受服务，且为应用层提供服务

- 传输层服务
  - 进程间通信
    - 提供进程间的通信
  - 地址：端口号
  - 传输层协议
    - 用户数据报协议UDP
    - 传输控制协议
      - 面向连接的可靠协议
      - 段

##### 网络层

> 负责源到目的地的消息的发送

- 网络层提供的服务
  - 打包
  - 数据包传递
    - 不可靠传递
    - 无连接传递
  - 路由
  - 网络层协议
    - 网际协议i（ip）

#####  数据链路层

- 无任何协议

##### 物理层

> 将从数据链路层接受的位转换成用于传输的电磁信号



#### 3 发起请求过程

> 当应用程序用tcp协议传输时，会把数据存放到协议栈中，最终通过比特数据流传入到网络中，每一层收到的数据都会在首部添加重要的信息。

<img src="https://yliang.oss-cn-shanghai.aliyuncs.com/img/programming/%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%AF%B7%E6%B1%82%E6%B5%81%E7%A8%8B.png" alt="img" style="zoom: 80%;" />

> 客户端如何找到目标服务:ARP协议，即如何找到mac地址

> 已知ip信息，获取目标机器的mac地址



#### 4 接收端收到数据包以后的处理过程

<img src="https://yliang.oss-cn-shanghai.aliyuncs.com/img/programming/%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%8E%A5%E5%8F%97%E8%AF%B7%E6%B1%82.png" alt="img" style="zoom:80%;" />

#### 5 TCP/IP 的分层管理

分层负载 

> 二层负载均衡会通过一个虚拟 MAC 地址接收请求，然后再分配到真实的 MAC 地址

> 三层负载均衡会通过一个虚拟 IP 地址接收请求，然后再分配到真实的 IP 地址

> 四层通过虚拟 IP + 端口接收请求，然后再分配到真实的服务器

> 七层通过虚拟的 URL 或主机名接收请求，然后再分配到真实的服务器。





### 二 TCP/IP 协议的深入分析

#### 1 TCP 握手协议

> 在数据进行传输前，需要通过三次 握手建立一个连接，所谓的三次握手，就是在建立 TCP 链接时，需要客户端和服务端总共发 送 3 个包来确认连接的建立

> 过程：
>
> A -> B 发送包
>
> B -> A 告知A，已收到包
>
> A -> B 告知B，已收到B -> A 的告知包
>
> AB建立连接

  

<img src="https://yliang.oss-cn-shanghai.aliyuncs.com/img/programming/%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B.png" alt="img" style="zoom:80%;" />



#### 2 TCP 四次挥手协议

> 四次挥手表示TCP断开连接的时候,需要客户端和服务端总共发送4个包以确认连接的断开；

> 客户端或服务器均可主动发起挥手动作(因为TCP是一个全双工协议)，在socket 编程中，任何一方执行close() 操作即可产生挥手操作。

> 单工：数据传输只支持数据在一个方向上传输

> 半双工：数据传输允许数据在两个方向上传输，但是在某一时刻，只允许在一个方向上传输，实际上有点像切换方向的单工通信

> 全双工：数据通信允许数据同时在两个方向上传输，因此全双工是两个单工通信方式的结合，它要求发送设备和接收设备都有独立的接收和发送能力

> 过程：
>
> A -> B 告知断开连接
>
> B -> A 告知准备结束应用
>
> B -> A 告知A已经准备好关闭，向A发送结束请求
>
> A -> B 告知B已确认
>
> 服务端关闭连接

![img](https://yliang.oss-cn-shanghai.aliyuncs.com/img/programming/%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B.png)



#### 3 SYN攻击

> 在三次握手过程中，Server发送SYN-ACK之后，收到Client的ACK之前的TCP连接称为半连接（half-open connect），此时Server处于SYN_RCVD状态，当收到ACK后，Server转入ESTABLISHED状态。SYN攻击就是Client在短时间内伪造大量不存在的IP地址，并向Server不断地发送SYN包，Server回复确认包，并等待Client的确认，由于源地址是不存在的，因此，Server需要不断重发直至超时，这些伪造的SYN包将产时间占用未连接队列，导致正常的SYN请求因为队列满而被丢弃，从而引起网络堵塞甚至系统瘫痪。SYN攻击时一种典型的DDOS攻击，检测SYN攻击的方式非常简单，即当Server上有大量半连接状态且源IP地址是随机的，则可以断定遭到SYN攻击了





### 三 TCP 的通信原理

#### 1 TCP 协议的通信过程

> 对于 TCP 通信来说，每个 TCP Socket(详情可见socket章节) 的内核中都有一个发送缓冲区和一个接收缓冲 区，TCP 的全双工的工作模式及 TCP 的滑动窗口就是依赖于这两个独立的 Buffer 和该 Buffer 的填充状态。(详情可见io模型章节)

> 接收缓冲区把数据缓存到内核，若应用进程一直没有调用 Socket 的 read 方法进行读取，那 么该数据会一直被缓存在接收缓冲区内。不管进程是否读取 Socket，对端发来的数据都会经 过内核接收并缓存到 Socket 的内核接收缓冲区。

> read 所要做的工作，就是把内核接收缓冲区中的数据复制到应用层用户的 Buffer 里。 进程调用 Socket 的 send 发送数据的时候，一般情况下是将数据从应用层用户的 Buffer 里复 制到 Socket 的内核发送缓冲区，然后 send 就会在上层返回。换句话说，send 返回时，数据 不一定会被发送到对端。

![img](https://yliang.oss-cn-shanghai.aliyuncs.com/img/programming/clipboard.png)

#### 2 滑动窗口协议

> 滑动窗口（Sliding window）是一种流量控制技 术。早期的网络通信中，通信双方不会考虑网络的拥挤情况直接发送数据。由于大家不知道 网络拥塞状况，同时发送数据，导致中间节点阻塞掉包，谁也发不了数据，所以就有了滑动 窗口机制来解决此问题；发送和接受方都会维护一个数据帧的序列，这个序列被称作	窗口

#### 3 发送窗口

> 就是发送端允许连续发送的幀的序号表。 发送端可以不等待应答而连续发送的最大幀数称为发送窗口的尺寸

#### 4 接收窗口

> 接收方允许接收的幀的序号表，凡落在 接收窗口内的幀，接收方都必须处理，落在接收窗口 外的幀被丢弃。 接收方每次允许接收的幀数称为接收窗口的尺寸。