## rabbitMQ

### 1 什么是rabbitMQ

#### 1.1 什么是mq

> 消息队列，即消息中间件可，以看作是一个中介收发消息

> 用高效可靠的消息传递机制进行与平台无关的数据交流，基于数据通信进行分布式系统的集成

### 2 为什么使用rabbitMQ

#### 2.1 解决了什么问题

- 异步通信

  > 当一个调用者发出请求后，不会立即得到结果，被调用者通过状态，通知来告知调用者或者通过回调函数来处理这个调用

- 解耦

  > 使得各个子系统之间的耦合性大大降低，各个系统由原来的流水式转变为散列式，MQ作为中间件通过收集生产者的消息，派发给各个消费者大大提高了性能

- 削峰

  > 由于quque的特性，先进先出，所以不管需要处理的请求量有多大，消费者都会按照顺序进行处理，同时也可以创建多个消费者加快处理的效率

#### 2.2 有什么特性

- 是一个独立运行的服务，生产者发送消息和消费者消费消息都需要和服务建立连接
- 采用队列作为数据结构，有先进先出的特点
- 具有发布订阅模型，消费根据需要消费消息



##### AMQP协议

> AMQP(advanced message queuing protocol)是一个提供统一消息服务的应用层标准协议，基于此协议的客户端与消息中间件可传递消息，并不受客户端/中间件不同产品，不同开发语言等 条件的限制。（总结，一个应用层的数据传输协议）



##### 结构组成



![rabbitmqv1](https://yliang.oss-cn-shanghai.aliyuncs.com/img/programming/rabbitmqv1.png)

###### 工作模型

1. broker作为一个主机可以看作是一个中介

2. vhost虚拟主机可以创建多个，避免系统间broker的混用，达到互不干扰的目的

3. exchange和需要接受消息的队列必须建立一个绑定关系，为每个队列指定一个特殊的标识，一个交换机可以路由给多个队列，一个队列可以接受来自多个交换机的消息

4. connection 生产者和消费者都需要和broker建立一个长连接

5. channel作为信道，长连接的一个虚拟连接，为了避免长连接的频繁的创建和销毁，在tcp长连接里创建和释放channel，大大降低资源的消耗

6. binding key作为规则的制定者，routingkey作为选择者

7. 队列消息派发的方式

- push 队列主动推送

  > 消息保存在客户端，实时性很高， 但是一旦消息消费不过来会产生消息的积压r

- pull 消费者主动获取

  > 每隔一段时间去获取，实时性会降低，但是消费者会根据可以根据自己的能力去获取消息的频率

8. Message消息体，根据不同通信协议定义的固定格式进行编码的数据包，来封装业务数据，实现消息的传输



###### 路由方式

exchange交换机作为一个派发消息的媒介，根据既有的规则进行消息的派发

- direct 直连

  > 一个队列与直连交换机绑定需要bindingkey，生产者发送消息携带路由键routingkey，判断是否和绑定键匹配

- topic 主题

  > 一个队列与主题交换机绑定时可以使用**#(多个单词)，*(一个单词)通配符表示**，需要bindingkey，生产者发送消息携带路由键routingkey，判断是否和绑定键匹配

- fanout 广播

  > 广播类型的交换机与队列绑定时，不需要绑定键和路由键，与之相连的队列，会收到相同的消息



##### 工作流程

![img](https://yliang.oss-cn-shanghai.aliyuncs.com/img/programming/20200228145533604.png)
1 发送端 MQ-Product （消息生产者）将消息发送给 MQ-server；
2 MQ-server 将消息落地，持久化到数据库等；
3 MQ-server 回 ACK 给 MQ-Producer；
4 MQ-server 将消息发送给消息接收端 MQ-Consumer （消息消费者）；
5 MQ-Consumer 消费接收到消息后发送 ACK 给 MQ-server；
6 MQ-server 将落地消息删除；





