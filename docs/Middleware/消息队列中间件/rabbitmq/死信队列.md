### 什么是死信队列

> 消息过期后，若无任何配置，被直接丢弃
>
> 通过配置让这样的消息有地方存储



### 死信队列的作用

- 场景

  > 想在某个时间之后执行任务

  

 - 方法

    - 在发送消息时，设置过期时间

     - 设置队列的过期时间

       

- 执行流程

  - 生产者 - 原交换机（过期）- 现交换机 - 死信队列 - 消费者



### 产生死信队列的条件

- 消息被消费之拒绝未设置重回队列
- 队列达到最大长度
- 消息过期



### 插件

基于延迟队列插件的实现（ Linux）
在 RabbitMQ 3.5.7 及 以 后 的 版 本 提 供 了 一 个 插 件（rabbitmq-delayed-message-exchange）来实现延时队列功能。同时插件依赖Erlang/OPT 18.0 及以上。

```
插件源码地址：
https://github.com/rabbitmq/rabbitmq-delayed-message-exchange
插件下载地址：
https://bintray.com/rabbitmq/community-plugins/rabbitmq_delayed_messa
ge_exchange
1、进入插件目录
whereis rabbitmq
cd /usr/lib/rabbitmq/lib/rabbitmq_server-3.6.12/plugins
2、下载插件
wget
https://bintray.com/rabbitmq/community-plugins/download_file?file_path=rabbitmq_delayed_message_exchange-0.0.1.e

如果下载的文件名带问号则需要改名，如图：
mv download_file?file_path=rabbitmq_delayed_message_exchange-0.0.1.ez
rabbitmq_delayed_message_exchange-0.0.1.ez  

3、启用插件
rabbitmq-plugins enable rabbitmq_delayed_message_exchange
4、停用插件
rabbitmq-plugins disable rabbitmq_delayed_message_exchange
5、插件使用
通过声明一个 x-delayed-message 类型的 Exchange 来使用 delayed-messaging特性。x-delayed-message 是插件提供的类型，并不是 rabbitmq 本身的（区别于 direct、topic、fanout、headers）。  
```



### 消息堆积的解决

> 当生产者的速度大于消费者时会产生消息堆积

#### 服务端

##### 对列

x-max-length：队列中最大存储最大消息数，超过这个数量，队头的消息会被丢弃。
x-max-length-bytes：队列中存储的最大消息容量（单位 bytes），超过这个容量，队头的消息会被丢弃  

##### 内存

当mq运行时会检测内存容量，当超过40%时，抛出内存警告阻断连接

`[{rabbit, [{vm_memory_high_watermark, 0.4}]}]  `

##### 磁盘控制

另一种方式是通过磁盘来控制消息的发布。当磁盘空间低于指定的值时（默认50MB），触发流控措施  

`disk_free_limit.relative = 3.0
disk_free_limit.absolute = 2GB  `



#### 消费端

> 默认情况下，如果不进行配置，RabbitMQ 会尽可能快速地把队列中的消息发送到消费者。因为消费者会在本地缓存消息，如果消息数量过多，可能会导致 OOM 或者影响其他进程的正常运行。  

可以基于 Consumer 或者 channel 设置 prefetch count 的值，含义为 Consumer  端的最大的 unacked messages 数目。当超过这个数值的消息未被确认，RabbitMQ 会停止投递新的消息给该消费者。  

```xml
channel.basicQos(2); // 如果超过 2 条消息没有发送 ACK， 当前消费者不再接受队列消息
channel.basicConsume(QUEUE_NAME, false, consumer);
```

