

##### **zookeeper的本质是一个分布式协调组件**

**或者说通过实现分布式锁来实现协调**

![img](C:\Users\xiaomi\AppData\Local\YNote\data\yangl546493589@163.com\15be6a8735cd4ecf8aa3ae29f5acb190\clipboard.png)

### **一 引入注册中心**

服务注册中心主要用于实现服务的注册和服务的发现功能，在微服务架构中，它起到了非常大的作用。

1. **注册中心的实现**

   Dubbo 体系中的 Zookeeper、 Spring Cloud 中的 Eureka 和 Consul

2. **分布式一致性**

   > 一个分布式系统中，有多个节点，每个节点都会提出一个请求，但是在所有节点中只能确定一个请求被通过。而这个通过是需要所有节点达成一致的结果，所以所谓的一致性就是在提出的所有请求中能够选出最终一个确定请求

   > zookeeper 并不是作为注册中心而设计，他是作为分布式锁的一种设计

   > 即 客户端发送多个请求，zookeeper通过分布式锁只允许其中一个请求进行访问，通过paxos协议（一致性算法）
   
   

### **二 集群特点**

**防止单点故障**

> 解决单点问题的方式就是集群

1. **节点要有角色定位**

   1. **Leader 角色**

      Leader 服务器是整个 zookeeper 集群的核心，主要的工作任务有两项
      1. > 事物请求的唯一调度和处理者，保证集群事物处理的顺序性

      2. > 集群内部各服务器的调度者

   2. **Follower 角色**

      1. 处理客户端非事物请求、转发事物请求给 leader 服务器
      2. 参与事物请求 Proposal 的投票（需要半数以上服务器通过才能通知 leader commit 数据;Leader 发起的提案，要求 Follower 投票）
      3. 参与 Leader 选举的投票

   3. **Observer 角色**

      1. Observer 是 zookeeper3.3 开始引入的一个全新的服务器角色，从字面来理解，该角色充当了观察者的角色。

      2. 观察 zookeeper 集群中的最新状态变化并将这些状态变化同步到 observer 服务器上。

         Observer 的工作原理与 follower 角色基本一致，而它和 follower 角色唯一的不同在于observer 不参与任何形式的投票，包括事物请求 Proposal 的投票和 leader 选举的投票。简单来说， observer 服务器只提供非事物请求服务，通常在于不影响集群事物处理能力的前提下提升集群非事物处理的能力

2. **数据的同步**
   
   1. **怎么同步**
      
      leader 节点负责协调和数据同步操作
      
      leader 节点可以处理事务和非事务型数据
      
      follower 节点只能处理非事务型数据
      
   2. **目的**：由一个节点来维护，使得集群数据处理的简化。同时数据需要能够通过 leader 进行分发使得数据在集群中各个节点的一致性
   
      1. **怎样保证leader 节点如何和其他节点保证数据一致性，并且要求是强一致的：**

![img](C:\Users\xiaomi\AppData\Local\YNote\data\yangl546493589@163.com\341eeae2e7c046d18b824c2edcd45f34\clipboard.png)



 				2. **方案**

​			      **关于 2PC 提交**

​				当一个事务操作需要跨越多个分布式节点的时候，为了保持事务处理的 ACID 特性，就需要引入一个“协调者”（TM）来统一调度				所有分布式节点的执行逻辑，这些被调度的分布式节点被称为 AP。 TM 负责调度 AP 的行为，并最终决定这些 AP 是否要把事务				真正进行提交；因为整个事务是分为两个阶段提交，所以叫 2pc

![img](C:\Users\xiaomi\AppData\Local\YNote\data\yangl546493589@163.com\4042c188e7854b59aec19dd75e6409cd\clipboard.png)

​		**阶段一：提交事务请求（投票）**

- 事务询问

  协调者向所有的参与者发送事务内容，询问是否可以执行事务提交操作，并开始等待各参与者的响应

- 执行事务

  各个参与者节点执行事务操作，并将 Undo 和 Redo 信息记录到事务日志中，尽量把提交过程中所有消耗时间的操作和准备都提前完成确保后面 100%成功提交事务

- 各个参与者向协调者反馈事务询问的响应

  如果各个参与者成功执行了事务操作，那么就反馈给参与者 yes 的响应，表示事务可以执行；

  如果参与者没有成功执行事务，就反馈给协调者 no 的响应，表示事务不可以执行，上面这个阶段有点类似协调者组织各个参与者对一次事务操作的投票表态过程，因此 2pc 协议的第一个阶段称为“投票阶段”，即各参与者投票表名是否需要继续执行接下去的事务提交操作。

  **阶段二：执行事务提交**

  在这个阶段，协调者会根据各参与者的反馈情况来决定最终是否可以进行事务提交操作，正常情况下包含两种可能:执行事务、中断事务



3. **leader选举**

   当 leader 挂了，需要从其他 follower 节点中选择一个新的节点进行处理， 这个时候就需要涉及到 leader 选举

   在主节点出现异常后，从节点通过投票选举，超过半数即可判定为选举成功。遵循2n + 1