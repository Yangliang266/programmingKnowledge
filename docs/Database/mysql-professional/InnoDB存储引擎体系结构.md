## InnoDB存储引擎体系结构



### InnoDB的定义

> 表存储引擎，基于磁盘存储的内存型引擎

### InnoDB的特点

> 支持事务
>
> 支持数据的行锁
>
> 支持多版本并发MVCC
>
> 支持外键

### InnoDB的结构

> 整个InnoDB由内存池，后台线程，底层的数据文件组成

#### 缓冲池（buffer pool）

> 可以看作是将频繁访问的数据放入内存中

1. 流程

   1. 读取页操作，将从磁盘读取的页放在缓存池下（内存）
   2. 读取相同的页，判断缓存是否命中
   3. 数据库页的修改在缓存池中
   4. 以checkpoint的机制刷新回磁盘

2. 作用

   > 减少io的变化，提高写入性能

3. LRU(最近最少使用原则算法)

   1. 作用：进行数据页的换进换出操作

   2. 存储原则：最频繁访问的放在头部，反之放在尾部，当不能存储时会释放尾部

      1. 优化：

         > 热点数据放在LRU的midpoint位置处，避免将活跃的数据（头部）挤出LRU列表

4. 预热

   1. 关闭mysql时把内存的数据放入ib_buffer_pool文件中



##### change buffer

> 作用：将二级索引的数据缓存，减少二级索引的随机io，达到操作合并的效果

1. 流程
   1. 判断是否是二级（非聚集索引）索引
   2. 放入插入缓冲池区中
   3. 执行插入缓冲和非聚集索引的页子节点合并 （不用更改一次索引，就调用一次索引页，而是择机merge合并操作，减少随机io）
2. 问题
   1. 合并在有大量二级索引页更新或者很多影响行的情况下会花费很多时间
3. 场景
   1. 写多读少，账单类，日志，不用当时就访问



##### 自适应hash索引

> 作用：当某个二级索引被频繁访问，就会为这个二级索引创建自适应hash索引，带来速度上的提升
>
> 创建时机：根据访问的频率和模式为某些页创建hash索引
>
> 场景：适合于等值查询，不适用于范围查询



##### redo log buffer

> 作用：存放将要写入到redolog文件的数据，当有insert，update，delete多个记录，增加redo log buffer节省io
>
> 存放的策略：0/1/2



##### double write

> 作用：为了提高数据写入可靠性
>
> 问题解决：页失效 -> 导致记录页信息的redolog的逻辑日志发生故障 -> 数据不一致
>
> 流程：写入page -> double write buffer -> 数据文件



#### 后台线程

##### master thread 主线程

> 作用：将缓存池中的数据异步刷新到磁盘，保证数据的一致性，脏页的刷新，合并插入缓冲

> 组成：主循环loop，后台循环，刷新循环，暂停循环

##### InnoDB后台io线程

> 负责io的请求回调

##### InnoDB脏页刷新线程

> 脏页：数据在内存中被修改与磁盘相比较，即为脏页
>
> 负责脏页的清理

##### InnoDB purge线程

> 负责回收已经使用并分配的undo页



#### 底层数据文件（见文件体系）

##### redolog

##### undo



